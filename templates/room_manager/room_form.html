{% import "utils.html.tera" as utils %}

{% match self.room_id %}
{% when Some with (room_id) %}
<form method="POST" action="{{ ty.as_route_base() }}/{{room_id}}" id="room-form">
{% when None %}
<form method="POST" id="room-form">
{% endmatch %}
    <div id='option-pages'>
        <div class="options-tab" id="section-room-options">
            <label for="room_name">{{ self.ty|capitalize +}} name:</label>
            <input type="text" name="room_name" id="room_name" value="{{self.room.name}}" minlength="1" required>

            {% if self.ty.is_room() %}
                <label for="close_date">Submission limit:</label>
                <input type="datetime-local" id="close_date" name="close_date">
            {% else %}
                <input style="display: none" type="datetime-local" id="close_date" name="close_date">
            {% endif %}

            <label for="room_description">Description:</label>
            <textarea name="room_description" id="room_description">
                {{- self.room.description -}}
            </textarea>

            <label for="room_url">Room URL:</label>
            <input type="text" id="room_url" name="room_url" value="{{self.room.room_url}}">
        </div>

        <div class="options-tab" id="section-advanced-options">
            <fieldset class="formset">
                <input type="checkbox" name="yaml_validation" id="yaml_validation" {%+ if self.room.yaml_validation %} checked {% endif %}>
                <label for="yaml_validation">Validate uploaded YAML files</label>

                <input type="checkbox" name="allow_unsupported" id="allow_unsupported" {%+ if self.room.allow_unsupported%} checked {% endif %}>
                <label for="allow_unsupported">Allow bypassing validation for games not on the lobby</label>
            </fieldset>

            <input type="checkbox" name="show_apworlds" id="show_apworlds" {%+ if self.room.show_apworlds%} checked {% endif %}>
            <label for="show_apworlds">Show the apworlds page for the room</label>

            <hr>

            <fieldset class="formset">
                <input type="checkbox" name="yaml_limit_per_user" id="yaml_limit_per_user" {%+ if self.room.yaml_limit_per_user.is_some() %} checked {% endif %}>
                <label for="yaml_limit_per_user">Limit the number of games a user can submit</label>

                <label for="yaml_limit_per_user_nb">Limit:</label>
                <input type="number" min=1 name="yaml_limit_per_user_nb" id="yaml_limit_per_user_nb" value="{{ self.room.yaml_limit_per_user.unwrap_or(1) }}">

                {% if base.is_admin %}
                <label for="yaml_limit_bypass_list">YAML limit bypass list:</label>
                {% endif %}
                <input {%+ if base.is_admin %}type="text"{%+ else %}type="hidden"{% endif +%} name="yaml_limit_bypass_list" id="yaml_limit_bypass_list" value="{{ self.room.yaml_limit_bypass_list|join(",") }}">

                {% match self.room_id %}
                {% when Some with (room_id) %}
                <hr>
                <h5>Danger zone</h5>
                <table class="styled danger-zone">
                    <tr>
                        <td>Delete this {{+ self.ty }}? {%+ if self.ty.is_room() %} This will delete all associated YAMLs, there is no going back. {% endif %}</td>
                        <td>
                            <a href="{{ ty.as_route_base() }}/{{room_id}}/delete" class="cancel-button" data-confirm-del=true data-resource-type="{{ self.ty }}" data-resource-name="{{self.room.name}}">Delete {{+ self.ty }}</a>
                        </td>
                    </tr>
                </table>
                {% when None %}
                {% endmatch %}
            </fieldset>
        </div>

        <div class="options-tab" id="section-apworlds-editor">
        {% include "room_manager/manifest_editor.html" %}
        </div>
        <input type="hidden" name="tz_offset" id="tz_offset">

    </div>

    <hr>
    <div id="save-button">
    {% if self.room_id.is_some() %}
        <button>Save {{+ self.ty }}</button>
    {% else %}
        <button>Create {{+ self.ty }}</button>
    {% endif%}
    </div>
</form>

{% block scripts %}
    <script src="/static/js/room_editor.js?{{ base.js_version}}"></script>
    <script src="/static/js/room.js?{{ base.js_version}}"></script>
    <script>
        const closeDateEl = document.getElementById("close_date");
        closeDateEl.addEventListener("change", () => {
            refreshTimezoneOffset(new Date(closeDateEl.value + "Z"))
        })

        const closeDate = new Date("{{self.room.close_date}}Z");
        refreshTimezoneOffset(closeDate);
        closeDateEl.value = dateToISOLikeButLocal(closeDate);

        const form = document.getElementById("room-form");
        const messages = document.getElementById("messages");
        for (const elmt of form.getElementsByTagName("input")) {
            elmt.addEventListener("invalid", () => {
                const message = document.createElement("p")
                message.className = "error";
                message.innerText = "One or more input is invalid.";

                messages.innerHTML = "";
                messages.appendChild(message);
            });
        }
    </script>
{% endblock %}
