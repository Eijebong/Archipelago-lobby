{% extends "base.html" %}
{% import "menu.html.tera" as menu %}
{% block menu %}
    {% let room_url = format!("/room/{}", self.room.id) %}
    {% call menu::menu_item("Room", "", room_url, true, "") %}
    {% call menu::menu_item("Upload yaml", "", "#upload", false, "uploadButton") %}
{% endblock %}
{% block main %}

<noscript>
    Gotta enable javascript for this to work, sorry
</noscript>

<table class="styled" id="room-info">
    <tr>
        <td>Room name</td>
        <td>{{ room.name }}</td>
    </tr>
    <tr>
        <td>Closing time</td>
        <td id="close-date">{{ room.close_date }}</td>
    </tr>
    <tr>
        <td>Players</td>
        <td>{{ player_count }}</td>
    </tr>
    {% if base.is_admin %}
    <tr>
        <td colspan="2"><a href="/room/{{room.id}}/yamls">Download YAMLs</a></td>
    </tr>
    {% endif %}
</div>

<table class="styled">
    <thead>
        <tr>
            <th>Player</th>
            <th>Game</th>
            <th>Action</th>
        </tr>
    </thead>
    <tbody>
        {% for yaml in yamls %}
        <tr>
            <td>{{yaml.player_name}}</td>
            <td>{{yaml.game}}</td>
            {% if yaml.owner_id.0 == base.user_id || base.is_admin %}
            <td><a href="/room/{{room.id}}/delete/{{yaml.id}}">Delete</a></td>
            {% else %}
            <td> - </td>
            {% endif %}
        </tr>
        {% endfor %}
    </tbody>
</table>

<form style="display: none" action="/room/{{room.id}}/upload" method="POST" enctype="multipart/form-data">
    <input type="file" name="yaml" id="yamlUpload" accept=".yml,.yaml" multiple=false/>
    <button id="yamlFormButton">Upload</button>
</form>
{%endblock%}

{% block scripts %}
<script>
    const yamlUpload = document.getElementById("yamlUpload");
    const yamlUploadButton = document.getElementById("uploadButton");
    const yamlFormButton = document.getElementById("yamlFormButton");

    yamlUploadButton.onclick = function() {
        yamlUpload.click();
    }

    yamlUpload.onchange = function() {
        if (yamlUpload.files.length == 1) {
            yamlFormButton.click();
        }
    }

    const closeDateEl = document.getElementById("close-date")
    const time = closeDateEl.innerText + "Z";
    const parsedTime = Date.parse(time);
    closeDateEl.innerText = new Intl.DateTimeFormat('default',
        {weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: 'numeric', minute: '2-digit', second: '2-digit', timeZoneName: 'longGeneric'}
    ).format(parsedTime);
</script>
{% endblock %}
