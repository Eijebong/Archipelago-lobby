{% extends "base.html" %}

{% block main %}
<noscript>
    Gotta enable javascript for this to work, sorry
</noscript>

<form>
    <select name="apworld" id="apworld">
        <option value="" {%+ if selected_apworld.is_none() %} selected {% endif %}>Select apworld</option>
        {% for (apworld_name, world_name) in self.apworlds %}
        <option value="{{apworld_name}}" {%+ if selected_apworld.as_ref() == Some(*apworld_name) %} selected {% endif %}>{{world_name}}</option>
        {% endfor %}
    </select>

    {% if let Some(selected_apworld) = self.selected_apworld %}
        <select name="version" id="version">
            <option value="" {%+ if selected_version.is_none() %} selected {% endif %}>Select version</option>
            {% for version in self.versions %}
            <option value="{{version}}" {%+ if selected_version.as_ref() == Some(*version) %} selected {% endif %}>{{version}}</option>
            {% endfor %}
        </select>
    {% endif %}
</form>

{% if let (Some(apworld), Some(version)) = (self.selected_apworld.as_ref(), self.selected_version.as_ref()) %}
<form id="options-form" method="POST" action="/options/{{apworld}}/{{version}}/download">
{% else %}
<form id="options-form">
{% endif %}
{% if self.options.is_some() %}
    <div class="option-row">
        <label for="player">Player name</label>
        <input type="text" id="player" name="player" placeholder="Player"/>
    </div>
{% endif %}
{% if let Some(option_groups) = self.options %}
    {% for (option_group, options) in option_groups.iter() %}
        <h2>{{option_group}}</h2>
        {% for (option_name, option_def) in options.iter() %}
            {% call option_input(option_name, option_def) %}{% endcall %}
        {% endfor %}
    {% endfor %}
    <button type="submit">Download YAML</button>
{% endif %}
</form>
{% endblock %}

{% macro option_input(option_name, option_def) %}
    <div class="option-row" data-type="{{option_def.ty}}" data-default="{{option_def.default_json()}}" data-name="{{option_name}}">
        {% match option_def.ty.as_str() %}
        {% when "bool" %}
            <input type="checkbox" id="{{option_name}}" class="bool-checkbox" {%+ if option_def.default_str() == "true" %}checked{% endif %}/>
        {% else %}
        {% endmatch %}
        <label for="{{option_name}}">{{option_def.display_name}} <i class="fa fa-circle-question tooltip-icon" tabindex="0" data-tooltip="{{option_def.description}}"></i></label>
        {% match option_def.ty.as_str() %}
        {% when "bool" %}
        {% when "range" %}
            {% let (min, max) = option_def.range_bounds() %}
            <div class="range-wrapper">
                <input id="{{option_name}}" type="number" value="{{option_def.default}}" min="{{min}}" max="{{max}}" required/>
                <span class="range-hint">({{min}} - {{max}})</span>
            </div>
        {% when "named_range" %}
            {% let (min, max) = option_def.range_bounds() %}
            <select id="{{option_name}}" class="preset-select" data-target="{{option_name}}_input">
                <option value="">Custom</option>
                {% for suggestion in option_def.suggestions() %}
                <option value="{{suggestion}}">{{suggestion}}</option>
                {% endfor %}
            </select>
            <div class="range-wrapper">
                <input type="number" id="{{option_name}}_input" value="{{option_def.default}}" min="{{min}}" max="{{max}}" required/>
                <span class="range-hint">({{min}} - {{max}})</span>
            </div>
        {% when "text_choice" %}
            <select id="{{option_name}}" class="preset-select" data-target="{{option_name}}_input">
                <option value="">Custom</option>
                {% for suggestion in option_def.suggestions() %}
                <option value="{{suggestion}}">{{suggestion}}</option>
                {% endfor %}
            </select>
            <input type="text" id="{{option_name}}_input" value="{{option_def.default_str()}}"/>
        {% when "choice" %}
            <select id="{{option_name}}">
            {% for choice in option_def.choices() %}
                <option value="{{choice}}" {%+ if option_def.default_str() == choice %}selected{% endif %}>{{choice}}</option>
            {% endfor %}
            </select>
        {% when "set" %}
            <select id="{{option_name}}" multiple>
            {% for value in option_def.valid_keys() %}
                <option value="{{value}}" {%+ if option_def.default_contains(value) %}selected{% endif %}>{{value}}</option>
            {% endfor %}
            </select>
        {% when "list" %}
            <div class="item-list" data-type="list" data-default="{{option_def.default_json()}}">
                <div class="item-list-items" id="{{option_name}}_items"></div>
                <div class="item-list-add-row">
                    <input type="text" list="{{option_name}}_datalist" placeholder="Add item..." class="item-list-input"/>
                    <datalist id="{{option_name}}_datalist">
                        {% for value in option_def.valid_keys() %}
                        <option value="{{value}}">
                        {% endfor %}
                    </datalist>
                    <button type="button" class="item-list-add">+</button>
                </div>
            </div>
        {% when "counter" %}
            <div class="item-list" data-type="counter" data-default="{{option_def.default_json()}}">
                <div class="item-list-items" id="{{option_name}}_items"></div>
                <div class="item-list-add-row">
                    <input type="text" list="{{option_name}}_datalist" placeholder="Add item..." class="item-list-input"/>
                    <datalist id="{{option_name}}_datalist">
                        {% for value in option_def.valid_keys() %}
                        <option value="{{value}}">
                        {% endfor %}
                    </datalist>
                    <button type="button" class="item-list-add">+</button>
                </div>
            </div>
        {% when "dict" %}
            <span class="option-not-supported">Not editable in this UI</span>
        {% else %}
            <input id="{{option_name}}" type="text" value="{{option_def.default_str()}}"/>
        {% endmatch %}
        {% if option_def.ty != "dict" %}
        <button type="button" class="option-reset" title="Reset to default"><i class="fa fa-rotate"></i></button>
        {% endif %}
        {% match option_def.ty.as_str() %}
        {% when "set" %}
        {% when "list" %}
        {% when "counter" %}
        {% when "dict" %}
        {% else %}
        <button type="button" class="option-random" title="Randomize"><i class="fa fa-dice"></i></button>
        {% endmatch %}
    </div>
{% endmacro %}

{% block scripts %}
<script>
    const apworld_input = document.getElementById("apworld");
    apworld_input.onchange = function(event) {
        const apworld_name = event.target.value;
        if (!apworld_name) return;
        window.location.href = `/options/${apworld_name}`
    }

    const version_input = document.getElementById("version");
    if (version_input) {
        version_input.onchange = function(event) {
            const apworld_name = apworld_input.value;
            const version = event.target.value;
            if (!version) return;
            window.location.href = `/options/${apworld_name}/${version}`
        }
    }

    function getRowValue(row) {
        const type = row.dataset.type;
        const randomBtn = row.querySelector('.option-random');
        if (randomBtn && randomBtn.classList.contains('active')) {
            return 'random';
        }

        switch (type) {
            case 'bool':
                return row.querySelector('.bool-checkbox').checked;
            case 'range':
                return parseInt(row.querySelector('input[type="number"]').value);
            case 'named_range': {
                const select = row.querySelector('.preset-select');
                if (select.value) return select.value;
                return parseInt(document.getElementById(select.dataset.target).value);
            }
            case 'text_choice': {
                const select = row.querySelector('.preset-select');
                if (select.value) return select.value;
                return document.getElementById(select.dataset.target).value;
            }
            case 'choice':
                return row.querySelector('select').value;
            case 'set':
                return Array.from(row.querySelector('select[multiple]').selectedOptions).map(o => o.value);
            case 'list':
                return Array.from(row.querySelectorAll('.item-list-item')).map(item => item.dataset.name);
            case 'counter': {
                const counter = {};
                row.querySelectorAll('.item-list-item').forEach(item => {
                    counter[item.dataset.name] = parseInt(item.querySelector('.item-list-qty').value);
                });
                return counter;
            }
            default:
                return row.querySelector('input[type="text"]')?.value || '';
        }
    }

    function createListItem(type, name, quantity = 1) {
        const item = document.createElement('div');
        item.className = 'item-list-item';
        item.dataset.name = name;

        const nameSpan = document.createElement('span');
        nameSpan.textContent = name;
        item.appendChild(nameSpan);

        if (type === 'counter') {
            const qtyInput = document.createElement('input');
            qtyInput.type = 'number';
            qtyInput.min = '1';
            qtyInput.value = quantity;
            qtyInput.className = 'item-list-qty';
            item.appendChild(qtyInput);
        }

        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.textContent = 'Ã—';
        removeBtn.className = 'item-list-remove';
        removeBtn.onclick = () => item.remove();
        item.appendChild(removeBtn);

        return item;
    }

    function resetToDefault(row) {
        const type = row.dataset.type;
        if (!type || type === 'dict') return;
        const defaultValue = JSON.parse(row.dataset.default);

        // If the default is "random", activate the random button
        if (defaultValue === 'random') {
            const randomBtn = row.querySelector('.option-random');
            if (randomBtn) {
                randomBtn.classList.add('active');
                row.querySelectorAll('input, select').forEach(input => input.disabled = true);
            }
            return;
        }

        switch (type) {
            case 'bool':
                row.querySelector('.bool-checkbox').checked = defaultValue === true || defaultValue === 'true';
                break;
            case 'range':
                row.querySelector('input[type="number"]').value = defaultValue;
                break;
            case 'named_range':
            case 'text_choice': {
                const select = row.querySelector('.preset-select');
                const input = document.getElementById(select.dataset.target);
                const matchingOption = Array.from(select.options).find(opt => opt.value === String(defaultValue));
                if (matchingOption) {
                    select.value = String(defaultValue);
                    input.disabled = true;
                } else {
                    select.value = '';
                    input.value = defaultValue;
                    input.disabled = false;
                }
                break;
            }
            case 'choice':
                row.querySelector('select').value = defaultValue;
                break;
            case 'set':
                Array.from(row.querySelector('select[multiple]').options).forEach(opt => {
                    opt.selected = defaultValue.includes(opt.value);
                });
                break;
            case 'list':
            case 'counter': {
                const itemsContainer = row.querySelector('.item-list-items');
                itemsContainer.innerHTML = '';
                if (type === 'list' && Array.isArray(defaultValue)) {
                    defaultValue.forEach(name => itemsContainer.appendChild(createListItem(type, name)));
                } else if (type === 'counter' && typeof defaultValue === 'object') {
                    Object.entries(defaultValue).forEach(([name, qty]) => {
                        itemsContainer.appendChild(createListItem(type, name, qty));
                    });
                }
                break;
            }
            default: {
                const input = row.querySelector('input[type="text"]');
                if (input) input.value = defaultValue;
            }
        }
    }

    // Make multi-selects toggle on click without needing Ctrl
    document.querySelectorAll('select[multiple]').forEach(select => {
        select.onmousedown = (e) => {
            if (e.target.tagName === 'OPTION' && !e.shiftKey) {
                e.preventDefault();
                e.target.selected = !e.target.selected;
            }
        };
    });

    document.querySelectorAll('.option-row').forEach(row => {
        resetToDefault(row);

        const resetBtn = row.querySelector('.option-reset');
        if (resetBtn) resetBtn.onclick = () => {
            row.querySelectorAll('input, select').forEach(input => input.disabled = false);
            const randomBtn = row.querySelector('.option-random');
            if (randomBtn) randomBtn.classList.remove('active');
            resetToDefault(row);
        };

        const randomBtn = row.querySelector('.option-random');
        if (randomBtn) randomBtn.onclick = () => {
            const isActive = randomBtn.classList.toggle('active');
            const inputs = row.querySelectorAll('input, select');

            if (isActive) {
                inputs.forEach(input => input.disabled = true);
            } else {
                inputs.forEach(input => input.disabled = false);
                const defaultValue = JSON.parse(row.dataset.default);
                if (defaultValue !== 'random') {
                    resetToDefault(row);
                } else {
                    // For number inputs, set to minimum value
                    const numberInput = row.querySelector('input[type="number"]');
                    if (numberInput && numberInput.min) {
                        numberInput.value = numberInput.min;
                    }
                }
            }
        };
    });

    // Handle preset select changes (enable/disable custom input)
    document.querySelectorAll('.preset-select').forEach(select => {
        const input = document.getElementById(select.dataset.target);
        if (!input) return;
        select.onchange = () => { input.disabled = !!select.value; };
    });

    // Handle item-list add functionality
    document.querySelectorAll('.item-list').forEach(container => {
        const row = container.closest('.option-row');
        const type = row.dataset.type;
        const itemsContainer = container.querySelector('.item-list-items');
        const input = container.querySelector('.item-list-input');
        const addBtn = container.querySelector('.item-list-add');

        addBtn.onclick = () => {
            const name = input.value.trim();
            if (!name) return;

            if (type === 'counter') {
                const existing = itemsContainer.querySelector(`[data-name="${CSS.escape(name)}"]`);
                if (existing) {
                    const qtyInput = existing.querySelector('.item-list-qty');
                    qtyInput.value = parseInt(qtyInput.value) + 1;
                    input.value = '';
                    return;
                }
            }

            itemsContainer.appendChild(createListItem(type, name));
            input.value = '';
        };

        input.onkeypress = (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                addBtn.click();
            }
        };
    });

    const form = document.getElementById('options-form');
    if (form) {
        form.onsubmit = (e) => {
            e.preventDefault();
            if (!form.reportValidity()) return;

            const formData = new FormData();
            formData.append('player', document.getElementById('player')?.value || '');

            document.querySelectorAll('.option-row[data-name]').forEach(row => {
                const name = row.dataset.name;
                const value = getRowValue(row);
                formData.append(name, typeof value === 'object' || typeof value === 'boolean' ? JSON.stringify(value) : value);
            });

            fetch(form.action, {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) throw new Error('Download failed');
                const disposition = response.headers.get('Content-Disposition');
                const match = disposition?.match(/filename="(.+)"/);
                const filename = match ? match[1] : 'options.yaml';
                return response.blob().then(blob => ({ blob, filename }));
            })
            .then(({ blob, filename }) => {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.click();
                URL.revokeObjectURL(url);
            })
            .catch(err => alert('Failed to download: ' + err.message));
        };
    }

    // Prevent tooltip clicks from triggering label behavior
    document.querySelectorAll('.tooltip-icon').forEach(icon => {
        icon.onclick = (e) => e.preventDefault();
    });
</script>
{% endblock %}
