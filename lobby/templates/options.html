{% extends "base.html" %}

{% block styles %}
<link rel="stylesheet" href="/static/css/help.css?{{ base.css_version }}">
{% endblock %}

{% block main %}
<noscript>
    Gotta enable javascript for this to work, sorry
</noscript>

{% if self.selected_apworld.is_none() %}
<section class="help-section">
    <div class="two-col">
        <div>
            <h4><i class="fa fa-file-circle-plus"></i> Create New YAML</h4>
            <p>Start fresh with a new configuration file for your game</p>
            <form>
                <select name="apworld" id="apworld" style="width: 100%">
                    <option value="">Select a game...</option>
                    {% for (apworld_name, world_name) in self.apworlds %}
                    <option value="{{apworld_name}}">{{world_name}}</option>
                    {% endfor %}
                </select>
            </form>
        </div>

        <div>
            <h4><i class="fa fa-file-pen"></i> Edit Existing YAML</h4>
            <p>Upload and modify an existing YAML file</p>
            <form method="POST" action="/options/edit" id="yaml-upload-form">
                <input type="file" name="yaml_file" id="yaml-upload" accept=".yaml,.yml" style="display:none">
                <input type="hidden" name="yaml" id="yaml-content">
                <button type="button" id="upload-yaml-btn" class="validation-button">Choose File</button>
            </form>
        </div>
    </div>
</section>
{% else %}
<form>
    <select name="apworld" id="apworld" {%+ if self.prefilled_values.is_some() %}disabled{% endif %}>
        {% for (apworld_name, world_name) in self.apworlds %}
        <option value="{{apworld_name}}" {%+ if selected_apworld.as_ref() == Some(*apworld_name) %} selected {% endif %}>{{world_name}}</option>
        {% endfor %}
    </select>

    {% if let Some(selected_apworld) = self.selected_apworld %}
        <select name="version" id="version" {%+ if self.prefilled_values.is_some() %}disabled{% endif %}>
            {% for version in self.versions %}
            <option value="{{version}}" {%+ if selected_version.as_ref() == Some(*version) %} selected {% endif %}>{{version}}</option>
            {% endfor %}
        </select>
    {% endif %}
</form>
{% endif %}

{% if let (Some(apworld), Some(version)) = (self.selected_apworld.as_ref(), self.selected_version.as_ref()) %}
<form id="options-form" method="POST" action="/options/{{apworld}}/{{version}}/download">
{% else %}
<form id="options-form">
{% endif %}
{% if !self.warnings.is_empty() %}
<div id="yaml-warnings">
    <strong>The following options from your YAML are not recognized (they may have been removed or renamed):</strong>
    <ul>
        {% for warning in self.warnings %}
        <li><code>{{warning}}</code></li>
        {% endfor %}
    </ul>
</div>
{% endif %}

{% if self.options.is_some() %}
    <div class="options-content">
    <div class="option-row">
        <label for="player">Player name</label>
        <input type="text" id="player" name="player" placeholder="{{self.default_player_name}}" value="{{self.prefilled_player_name.as_deref().unwrap_or(&self.default_player_name)}}"/>
    </div>
    {% if let Some(desc) = self.prefilled_description %}
    <input type="hidden" name="description" value="{{desc}}"/>
    {% endif %}
{% endif %}
{% if let Some(option_groups) = self.options %}
    {% for (option_group, options) in option_groups.iter() %}
        <h2>{{option_group}}</h2>
        {% for (option_name, option_def) in options.iter() %}
            {% let prefilled = self.get_prefilled(option_name) %}
            {% call option_input(option_name, option_def, prefilled) %}{% endcall %}
        {% endfor %}
    {% endfor %}
    </div>
    <div class="options-submit">
        <button type="submit"><i class="fa fa-download"></i> Download YAML</button>
    </div>
{% endif %}
</form>

<div id="weight-modal" class="modal hidden">
    <div class="modal-content">
        <h3 id="weight-modal-title">Configure Weights</h3>
        <div id="weight-modal-add" class="weight-add-row hidden">
            <input type="number" id="weight-modal-new-value" placeholder="Value">
            <button type="button" id="weight-modal-add-btn">Add</button>
        </div>
        <form id="weight-modal-form">
            <div id="weight-modal-items"></div>
            <div class="modal-buttons">
                <button type="submit" id="weight-modal-save">Save</button>
                <button type="button" id="weight-modal-cancel">Cancel</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% macro option_input(option_name, option_def, prefilled) %}
    <div class="option-row" data-type="{{option_def.ty}}" data-default="{{option_def.default_json()}}" data-name="{{option_name}}"
        {%~ match option_def.ty.as_str() ~%}
        {%~ when "bool" %} data-choices='["true","false"]'
        {%~ when "choice" %} data-choices='{{option_def.choices()|json}}'
        {%~ when "named_range" %} data-choices='{{option_def.suggestions()|json}}' data-range='{{option_def.range_bounds().0}},{{option_def.range_bounds().1}}'
        {%~ when "text_choice" %} data-choices='{{option_def.suggestions()|json}}'
        {%~ when "range" %} data-range='{{option_def.range_bounds().0}},{{option_def.range_bounds().1}}'
        {%~ else ~%}
        {%~ endmatch ~%}
        {%~ if self.is_weighted(prefilled) %} data-weights='{{self.weights_json(prefilled)}}'{% endif ~%}
    >
        {% match option_def.ty.as_str() %}
        {% when "bool" %}
            <input type="checkbox" id="{{option_name}}" class="bool-checkbox" {%+ if prefilled.is_some() %}data-prefilled="true"{% endif %} {%+ if self.prefilled_bool(prefilled, option_def.default_str() == "true") %}checked{% endif %}/>
        {% else %}
        {% endmatch %}
        <label for="{{option_name}}">{{option_def.display_name}}{%+ if self.is_new_option(option_name) %} <span class="option-new-badge">new</span>{% endif %}{%+ if self.is_outdated(option_name) %} <span class="option-outdated-badge">invalid</span>{% endif %} <i class="fa fa-circle-question tooltip-icon" tabindex="0" data-tooltip="{{option_def.description}}"></i></label>
        {% match option_def.ty.as_str() %}
        {% when "bool" %}
        {% when "range" %}
            {% let (min, max) = option_def.range_bounds() %}
            <div class="range-wrapper" {%+ if prefilled.is_some() %}data-prefilled="true"{% endif %}>
                {% if let Some(v) = prefilled %}
                <input id="{{option_name}}" type="number" value="{{v}}" min="{{min}}" max="{{max}}" required/>
                {% else %}
                <input id="{{option_name}}" type="number" value="{{option_def.default}}" min="{{min}}" max="{{max}}" required/>
                {% endif %}
                <span class="range-hint">({{min}} - {{max}})</span>
            </div>
        {% when "named_range" %}
            {% let (min, max) = option_def.range_bounds() %}
            {% let pstr = self.prefilled_str(prefilled) %}
            {% let default_is_suggestion = self.default_is_suggestion(option_def) %}
            {% let default_str = self.default_str(option_def) %}
            <select id="{{option_name}}" class="preset-select" data-target="{{option_name}}_input" {%+ if prefilled.is_some() %}data-prefilled="true"{% endif %}>
                <option value="">Custom</option>
                {% for suggestion in option_def.suggestions() %}
                <option value="{{suggestion}}" {%+ if pstr == Some(*suggestion) || (pstr.is_none() && default_str == Some(*suggestion)) %}selected{% endif %}>{{suggestion}}</option>
                {% endfor %}
            </select>
            <div class="range-wrapper">
                {% if let Some(v) = prefilled %}
                <input type="number" id="{{option_name}}_input" value="{{v}}" min="{{min}}" max="{{max}}" required {%+ if pstr.is_some() %}disabled{% endif %}/>
                {% else if default_is_suggestion %}
                <input type="number" id="{{option_name}}_input" value="{{min}}" min="{{min}}" max="{{max}}" required disabled/>
                {% else %}
                <input type="number" id="{{option_name}}_input" value="{{option_def.default}}" min="{{min}}" max="{{max}}" required/>
                {% endif %}
                <span class="range-hint">({{min}} - {{max}})</span>
            </div>
        {% when "text_choice" %}
            {% let pstr = self.prefilled_str(prefilled) %}
            <select id="{{option_name}}" class="preset-select" data-target="{{option_name}}_input" {%+ if prefilled.is_some() %}data-prefilled="true"{% endif %}>
                <option value="">Custom</option>
                {% for suggestion in option_def.suggestions() %}
                <option value="{{suggestion}}" {%+ if pstr == Some(*suggestion) %}selected{% endif %}>{{suggestion}}</option>
                {% endfor %}
            </select>
            {% if let Some(ps) = pstr %}
                {% let is_preset = self.suggestions_contain(&option_def.suggestions(), ps) %}
                <input type="text" id="{{option_name}}_input" value="{{ps}}" {%+ if is_preset %}disabled{% endif %}/>
            {% else %}
            <input type="text" id="{{option_name}}_input" value="{{option_def.default_str()}}"/>
            {% endif %}
        {% when "choice" %}
            {% let pstr = self.prefilled_str(prefilled) %}
            <select id="{{option_name}}" {%+ if prefilled.is_some() %}data-prefilled="true"{% endif %}>
            {% for choice in option_def.choices() %}
                <option value="{{choice}}" {%+ if pstr.unwrap_or(option_def.default_str()) == choice %}selected{% endif %}>{{choice}}</option>
            {% endfor %}
            </select>
        {% when "set" %}
            {% if option_def.has_valid_keys() %}
            {% let parr = self.prefilled_array(prefilled) %}
            <div class="set-picker" id="{{option_name}}_picker" {%+ if parr.is_some() %}data-prefilled="true"{% endif %}>
                <div class="set-selected" id="{{option_name}}_selected">
                    {% if let Some(arr) = parr %}
                        {% for item in arr %}
                            {% if let Some(name) = item.as_str() %}
                            <div class="item-list-item" data-value="{{name}}"><span>{{name}}</span> <button type="button" class="item-list-remove">×</button></div>
                            {% endif %}
                        {% endfor %}
                    {% else %}
                        {% for value in option_def.valid_keys() %}
                            {% if option_def.default_contains(value) %}
                            <div class="item-list-item" data-value="{{value}}"><span>{{value}}</span> <button type="button" class="item-list-remove">×</button></div>
                            {% endif %}
                        {% endfor %}
                    {% endif %}
                </div>
                <input type="text" class="set-filter" placeholder="Filter options..." id="{{option_name}}_filter"/>
                <select id="{{option_name}}" multiple class="set-options">
                {% for value in option_def.valid_keys() %}
                    {% if let Some(arr) = parr %}
                    <option value="{{value}}" {%+ if self.array_contains_str(arr, value) %}selected{% endif %}>{{value}}</option>
                    {% else %}
                    <option value="{{value}}" {%+ if option_def.default_contains(value) %}selected{% endif %}>{{value}}</option>
                    {% endif %}
                {% endfor %}
                </select>
            </div>
            {% else %}
            <input type="hidden" id="{{option_name}}" value='{% if prefilled.is_some() %}{{self.prefilled_json(prefilled)|e}}{% else %}{{option_def.default_json()|e}}{% endif %}'/>
            <span class="option-not-supported">Not editable in this UI</span>
            {% endif %}
        {% when "list" %}
            {% if option_def.has_valid_keys() %}
            {% let parr = self.prefilled_array(prefilled) %}
            <div class="item-list" data-type="list" data-default="{{option_def.default_json()}}" {%+ if parr.is_some() %}data-prefilled="true"{% endif %}>
                <div class="item-list-items" id="{{option_name}}_items">
                    {% if let Some(arr) = parr %}
                        {% for item in arr %}
                            {% if let Some(name) = item.as_str() %}
                            <div class="item-list-item" data-name="{{name}}">
                                <span>{{name}}</span>
                                <button type="button" class="item-list-remove">×</button>
                            </div>
                            {% endif %}
                        {% endfor %}
                    {% endif %}
                </div>
                <div class="item-list-add-row">
                    <input type="text" list="{{option_name}}_datalist" placeholder="Add item..." class="item-list-input"/>
                    <datalist id="{{option_name}}_datalist">
                        {% for value in option_def.valid_keys() %}
                        <option value="{{value}}">
                        {% endfor %}
                    </datalist>
                    <button type="button" class="item-list-add">+</button>
                </div>
            </div>
            {% else %}
            <input type="hidden" id="{{option_name}}" value='{% if prefilled.is_some() %}{{self.prefilled_json(prefilled)|e}}{% else %}{{option_def.default_json()|e}}{% endif %}'/>
            <span class="option-not-supported">Not editable in this UI</span>
            {% endif %}
        {% when "counter" %}
            {% if option_def.has_valid_keys() %}
            {% let pobj = self.prefilled_object(prefilled) %}
            <div class="item-list" data-type="counter" data-default="{{option_def.default_json()}}" {%+ if pobj.is_some() %}data-prefilled="true"{% endif %}>
                <div class="item-list-items" id="{{option_name}}_items">
                    {% if let Some(obj) = pobj %}
                        {% for (name, qty) in obj %}
                            <div class="item-list-item" data-name="{{name}}">
                                <span>{{name}}</span>
                                <input type="number" min="1" value="{{qty}}" class="item-list-qty"/>
                                <button type="button" class="item-list-remove">×</button>
                            </div>
                        {% endfor %}
                    {% endif %}
                </div>
                <div class="item-list-add-row">
                    <input type="text" list="{{option_name}}_datalist" placeholder="Add item..." class="item-list-input"/>
                    <datalist id="{{option_name}}_datalist">
                        {% for value in option_def.valid_keys() %}
                        <option value="{{value}}">
                        {% endfor %}
                    </datalist>
                    <button type="button" class="item-list-add">+</button>
                </div>
            </div>
            {% else %}
            <input type="hidden" id="{{option_name}}" value='{% if prefilled.is_some() %}{{self.prefilled_json(prefilled)|e}}{% else %}{{option_def.default_json()|e}}{% endif %}'/>
            <span class="option-not-supported">Not editable in this UI</span>
            {% endif %}
        {% when "dict" %}
            {% if option_def.is_editable() %}
            {% let pobj = self.prefilled_object(prefilled) %}
            <div class="dict-picker" id="{{option_name}}_picker" data-type="dict" data-default="{{option_def.default_json()}}" {%+ if pobj.is_some() %}data-prefilled="true"{% endif %}>
                <div class="dict-selected" id="{{option_name}}_selected">
                    {% if let Some(obj) = pobj %}
                        {% for (name, qty) in obj %}
                            <div class="item-list-item" data-value="{{name}}">
                                <span>{{name}}</span>
                                <input type="number" value="{{qty}}" class="item-list-qty"/>
                                <button type="button" class="item-list-remove">×</button>
                            </div>
                        {% endfor %}
                    {% else %}
                        {% for value in option_def.valid_keys() %}
                            {% if option_def.default_dict_has(value) %}
                            <div class="item-list-item" data-value="{{value}}">
                                <span>{{value}}</span>
                                <input type="number" value="{{option_def.default_dict_get(value)}}" class="item-list-qty"/>
                                <button type="button" class="item-list-remove">×</button>
                            </div>
                            {% endif %}
                        {% endfor %}
                    {% endif %}
                </div>
                <input type="text" class="dict-filter" placeholder="Filter options..." id="{{option_name}}_filter"/>
                <select id="{{option_name}}" multiple class="dict-options">
                {% for value in option_def.valid_keys() %}
                    {% if let Some(obj) = pobj %}
                    <option value="{{value}}" {%+ if obj.contains_key(*value) %}selected{% endif %}>{{value}}</option>
                    {% else %}
                    <option value="{{value}}" {%+ if option_def.default_dict_has(value) %}selected{% endif %}>{{value}}</option>
                    {% endif %}
                {% endfor %}
                </select>
            </div>
            {% else %}
            <input type="hidden" id="{{option_name}}" value='{% if prefilled.is_some() %}{{self.prefilled_json(prefilled)|e}}{% else %}{{option_def.default_json()|e}}{% endif %}'/>
            <span class="option-not-supported">Not editable in this UI</span>
            {% endif %}
        {% when "unknown" %}
            {% if prefilled.is_some() %}
                <input type="hidden" id="{{option_name}}" value='{{self.prefilled_json(prefilled)|e}}'/>
                <span class="option-not-supported">Not editable in this UI</span>
            {% else %}
                <span class="option-not-supported">Not editable in this UI. No default value</span>
            {% endif %}
        {% else %}
            {% if option_def.has_complex_default() %}
            <input type="hidden" id="{{option_name}}" value='{% if prefilled.is_some() %}{{self.prefilled_json(prefilled)|e}}{% else %}{{option_def.default_json()|e}}{% endif %}'/>
            <span class="option-not-supported">Not editable in this UI</span>
            {% else if let Some(v) = self.prefilled_str(prefilled) %}
            <input id="{{option_name}}" type="text" value="{{v}}" data-prefilled="true"/>
            {% else %}
            <input id="{{option_name}}" type="text" value="{{option_def.default_str()}}"/>
            {% endif %}
        {% endmatch %}
        {% if option_def.is_editable() %}
        <button type="button" class="option-reset" title="Reset to default"><i class="fa fa-rotate"></i></button>
        {% endif %}
        {% match option_def.ty.as_str() %}
        {% when "set" | "list" | "counter" | "dict" | "text" %}
        {% else %}
        <button type="button" class="option-random" title="Randomize"><i class="fa fa-dice"></i></button>
        {% endmatch %}
        {% match option_def.ty.as_str() %}
        {% when "choice" | "named_range" | "bool" | "text_choice" | "range" %}
        <button type="button" class="option-weighted {%+ if self.is_weighted(prefilled) %} active{% endif %}" title="Configure weights"><i class="fa fa-scale-balanced"></i></button>
        {% else %}
        {% endmatch %}
    </div>
{% endmacro %}

{% block scripts %}
<script>
    // YAML upload handling
    document.getElementById('upload-yaml-btn')?.addEventListener('click', () => {
        document.getElementById('yaml-upload').click();
    });

    document.getElementById('yaml-upload')?.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const content = await file.text();
        document.getElementById('yaml-content').value = content;
        document.getElementById('yaml-upload-form').submit();
    });

    const apworld_input = document.getElementById("apworld");
    apworld_input.onchange = function(event) {
        const apworld_name = event.target.value;
        if (!apworld_name) return;
        window.location.href = `/options/${apworld_name}`
    }

    const version_input = document.getElementById("version");
    if (version_input) {
        version_input.onchange = function(event) {
            const apworld_name = apworld_input.value;
            const version = event.target.value;
            if (!version) return;
            window.location.href = `/options/${apworld_name}/${version}`
        }
    }

    function getRowValue(row) {
        const type = row.dataset.type;
        const randomBtn = row.querySelector('.option-random');
        if (randomBtn && randomBtn.classList.contains('active')) {
            return 'random';
        }

        const weightedBtn = row.querySelector('.option-weighted');
        if (weightedBtn && weightedBtn.classList.contains('active') && row.dataset.weights) {
            return JSON.parse(row.dataset.weights);
        }

        switch (type) {
            case 'bool':
                return row.querySelector('.bool-checkbox').checked;
            case 'range':
                return parseInt(row.querySelector('input[type="number"]').value);
            case 'named_range': {
                const select = row.querySelector('.preset-select');
                if (select.value) return select.value;
                return parseInt(document.getElementById(select.dataset.target).value);
            }
            case 'text_choice': {
                const select = row.querySelector('.preset-select');
                if (select.value) return select.value;
                return document.getElementById(select.dataset.target).value;
            }
            case 'choice':
                return row.querySelector('select').value;
            case 'set':
                return Array.from(row.querySelector('select[multiple]').selectedOptions).map(o => o.value);
            case 'list':
                return Array.from(row.querySelectorAll('.item-list-item')).map(item => item.dataset.name);
            case 'counter': {
                const obj = {};
                row.querySelectorAll('.item-list-item').forEach(item => {
                    obj[item.dataset.name] = parseInt(item.querySelector('.item-list-qty').value);
                });
                return obj;
            }
            case 'dict': {
                const obj = {};
                row.querySelectorAll('.dict-selected .item-list-item').forEach(item => {
                    obj[item.dataset.value] = parseInt(item.querySelector('.item-list-qty').value);
                });
                return obj;
            }
            default:
                return row.querySelector('input[type="text"]')?.value || '';
        }
    }

    function createListItem(type, name, quantity = 1) {
        const item = document.createElement('div');
        item.className = 'item-list-item';
        item.dataset.name = name;

        const nameSpan = document.createElement('span');
        nameSpan.textContent = name;
        item.appendChild(nameSpan);

        if (type === 'counter' || type === 'dict') {
            const qtyInput = document.createElement('input');
            qtyInput.type = 'number';
            if (type === 'counter') qtyInput.min = '1';
            qtyInput.value = quantity;
            qtyInput.className = 'item-list-qty';
            item.appendChild(qtyInput);
        }

        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.textContent = '×';
        removeBtn.className = 'item-list-remove';
        removeBtn.onclick = () => item.remove();
        item.appendChild(removeBtn);

        return item;
    }

    function resetToDefault(row) {
        const type = row.dataset.type;
        if (!type) return;
        const defaultValue = JSON.parse(row.dataset.default);

        // If the default is "random", activate the random button
        if (defaultValue === 'random') {
            const randomBtn = row.querySelector('.option-random');
            if (randomBtn) {
                randomBtn.classList.add('active');
                row.querySelectorAll('input, select').forEach(input => input.disabled = true);
            }
            return;
        }

        switch (type) {
            case 'bool':
                row.querySelector('.bool-checkbox').checked = defaultValue === true || defaultValue === 'true';
                break;
            case 'range':
                row.querySelector('input[type="number"]').value = defaultValue;
                break;
            case 'named_range':
            case 'text_choice': {
                const select = row.querySelector('.preset-select');
                const input = document.getElementById(select.dataset.target);
                const matchingOption = Array.from(select.options).find(opt => opt.value === String(defaultValue));
                if (matchingOption) {
                    select.value = String(defaultValue);
                    input.disabled = true;
                } else {
                    select.value = '';
                    input.value = defaultValue;
                    input.disabled = false;
                }
                break;
            }
            case 'choice':
                row.querySelector('select').value = defaultValue;
                break;
            case 'set': {
                const select = row.querySelector('select[multiple]');
                if (!select) return; // Non-editable
                Array.from(select.options).forEach(opt => {
                    opt.selected = defaultValue.includes(opt.value);
                    opt.style.display = '';
                });
                const filter = row.querySelector('.set-filter');
                if (filter) filter.value = '';
                if (select.classList.contains('set-options')) {
                    updateSetChips(select);
                }
                break;
            }
            case 'list':
            case 'counter': {
                const itemsContainer = row.querySelector('.item-list-items');
                if (!itemsContainer) return; // Non-editable
                itemsContainer.innerHTML = '';
                if (type === 'list' && Array.isArray(defaultValue)) {
                    defaultValue.forEach(name => itemsContainer.appendChild(createListItem(type, name)));
                } else if (type === 'counter' && typeof defaultValue === 'object') {
                    Object.entries(defaultValue).forEach(([name, qty]) => {
                        itemsContainer.appendChild(createListItem(type, name, qty));
                    });
                }
                break;
            }
            case 'dict': {
                const select = row.querySelector('select.dict-options');
                if (!select) return; // Non-editable
                Array.from(select.options).forEach(opt => {
                    opt.selected = defaultValue.hasOwnProperty(opt.value);
                    opt.style.display = '';
                });
                const filter = row.querySelector('.dict-filter');
                if (filter) filter.value = '';
                updateDictChips(select, defaultValue);
                break;
            }
            default: {
                const input = row.querySelector('input[type="text"]');
                if (input) input.value = defaultValue;
            }
        }
    }

    // Make multi-selects toggle on click without needing Ctrl
    document.querySelectorAll('select[multiple]').forEach(select => {
        select.onmousedown = (e) => {
            if (e.target.tagName === 'OPTION' && !e.shiftKey) {
                e.preventDefault();
                e.target.selected = !e.target.selected;
                select.dispatchEvent(new Event('change'));
            }
        };
    });

    const MAX_CHIPS = 100;

    function updatePickerChips(select, values = null) {
        const isDict = select.classList.contains('dict-options');
        const picker = select.closest(isDict ? '.dict-picker' : '.set-picker');
        const chipsContainer = picker.querySelector(isDict ? '.dict-selected' : '.set-selected');

        // For dict, preserve current values if not resetting
        const currentValues = {};
        if (isDict && !values) {
            chipsContainer.querySelectorAll('.item-list-item').forEach(item => {
                currentValues[item.dataset.value] = parseInt(item.querySelector('.item-list-qty').value) || 1;
            });
        }

        chipsContainer.innerHTML = '';
        const selected = Array.from(select.selectedOptions);
        const toShow = isDict ? selected : selected.slice(0, MAX_CHIPS);

        toShow.forEach(opt => {
            const chip = document.createElement('div');
            chip.className = 'item-list-item';
            chip.dataset.value = opt.value;

            if (isDict) {
                const qty = values ? (values[opt.value] ?? 1) : (currentValues[opt.value] ?? 1);
                chip.innerHTML = `<span>${opt.value}</span><input type="number" value="${qty}" class="item-list-qty"/><button type="button" class="item-list-remove">×</button>`;
            } else {
                chip.innerHTML = `<span>${opt.value}</span><button type="button" class="item-list-remove">×</button>`;
            }

            chip.querySelector('.item-list-remove').onclick = () => {
                opt.selected = false;
                updatePickerChips(select);
            };
            chipsContainer.appendChild(chip);
        });

        if (!isDict && selected.length > MAX_CHIPS) {
            const more = document.createElement('div');
            more.className = 'item-list-item set-chip-more';
            more.textContent = `+${selected.length - MAX_CHIPS} more`;
            chipsContainer.appendChild(more);
        }
    }

    // Keep aliases for resetToDefault compatibility
    const updateSetChips = updatePickerChips;
    const updateDictChips = updatePickerChips;

    document.querySelectorAll('.set-picker, .dict-picker').forEach(picker => {
        const isDict = picker.classList.contains('dict-picker');
        const select = picker.querySelector('select');
        const filter = picker.querySelector(isDict ? '.dict-filter' : '.set-filter');
        const chipsSelector = isDict ? '.dict-selected' : '.set-selected';

        picker.querySelectorAll(`${chipsSelector} .item-list-remove`).forEach(btn => {
            btn.onclick = () => {
                const chip = btn.closest('.item-list-item');
                const option = select.querySelector(`option[value="${CSS.escape(chip.dataset.value)}"]`);
                if (option) option.selected = false;
                updatePickerChips(select);
            };
        });

        select.addEventListener('change', () => updatePickerChips(select));

        filter.oninput = () => {
            const query = filter.value.toLowerCase();
            Array.from(select.options).forEach(opt => {
                opt.style.display = opt.value.toLowerCase().includes(query) ? '' : 'none';
            });
        };
    });

    document.querySelectorAll('.option-row').forEach(row => {
        // Skip resetToDefault if items were pre-rendered server-side
        if (!row.querySelector('[data-prefilled="true"]')) {
            resetToDefault(row);
        }

        row.querySelectorAll('.item-list .item-list-remove').forEach(btn => {
            btn.onclick = () => btn.closest('.item-list-item').remove();
        });

        if (row.dataset.weights) {
            row.querySelectorAll('input:not([type="hidden"]), select').forEach(el => el.disabled = true);
        }

        const resetBtn = row.querySelector('.option-reset');
        if (resetBtn) resetBtn.onclick = () => {
            row.querySelectorAll('input, select').forEach(input => input.disabled = false);
            const randomBtn = row.querySelector('.option-random');
            if (randomBtn) randomBtn.classList.remove('active');
            const weightedBtn = row.querySelector('.option-weighted');
            if (weightedBtn) {
                weightedBtn.classList.remove('active');
                delete row.dataset.weights;
            }
            resetToDefault(row);
        };

        const randomBtn = row.querySelector('.option-random');
        if (randomBtn) randomBtn.onclick = () => {
            const isActive = randomBtn.classList.toggle('active');
            const inputs = row.querySelectorAll('input, select');

            if (isActive) {
                inputs.forEach(input => input.disabled = true);
                const weightedBtn = row.querySelector('.option-weighted');
                if (weightedBtn) {
                    weightedBtn.classList.remove('active');
                    delete row.dataset.weights;
                }
            } else {
                inputs.forEach(input => input.disabled = false);
                const defaultValue = JSON.parse(row.dataset.default);
                if (defaultValue !== 'random') {
                    resetToDefault(row);
                } else {
                    // For number inputs, set to minimum value
                    const numberInput = row.querySelector('input[type="number"]');
                    if (numberInput && numberInput.min) {
                        numberInput.value = numberInput.min;
                    }
                }
            }
        };
    });

    // Handle preset select changes (enable/disable custom input)
    document.querySelectorAll('.preset-select').forEach(select => {
        const input = document.getElementById(select.dataset.target);
        if (!input) return;
        select.onchange = () => { input.disabled = !!select.value; };
    });

    // Handle item-list add functionality
    document.querySelectorAll('.item-list').forEach(container => {
        const row = container.closest('.option-row');
        const type = row.dataset.type;
        const itemsContainer = container.querySelector('.item-list-items');
        const input = container.querySelector('.item-list-input');
        const addBtn = container.querySelector('.item-list-add');

        addBtn.onclick = () => {
            const name = input.value.trim();
            if (!name) return;

            if (type === 'counter' || type === 'dict') {
                const existing = itemsContainer.querySelector(`[data-name="${CSS.escape(name)}"]`);
                if (existing) {
                    const qtyInput = existing.querySelector('.item-list-qty');
                    qtyInput.value = parseInt(qtyInput.value) + 1;
                    input.value = '';
                    return;
                }
            }

            itemsContainer.appendChild(createListItem(type, name));
            input.value = '';
        };

        input.onkeypress = (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                addBtn.click();
            }
        };
    });

    const form = document.getElementById('options-form');
    if (form) {
        form.onsubmit = (e) => {
            e.preventDefault();
            if (!form.reportValidity()) return;

            const formData = new FormData();
            formData.append('player', document.getElementById('player')?.value || '');

            const descInput = form.querySelector('input[name="description"]');
            if (descInput) formData.append('description', descInput.value);

            document.querySelectorAll('.option-row[data-name]').forEach(row => {
                const name = row.dataset.name;

                if (row.querySelector('.option-not-supported')) {
                    const hiddenInput = row.querySelector('input[type="hidden"]');
                    if (hiddenInput) {
                        formData.append(name, hiddenInput.value);
                    }
                    return;
                }

                const value = getRowValue(row);
                const type = row.dataset.type;
                formData.append(name, typeof value === 'object' || typeof value === 'boolean' || type === 'text' ? JSON.stringify(value) : value);
            });

            fetch(form.action, {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) throw new Error('Download failed');
                const disposition = response.headers.get('Content-Disposition');
                const match = disposition?.match(/filename="(.+)"/);
                const filename = match ? match[1] : 'options.yaml';
                return response.blob().then(blob => ({ blob, filename }));
            })
            .then(({ blob, filename }) => {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.click();
                URL.revokeObjectURL(url);
            })
            .catch(err => alert('Failed to download: ' + err.message));
        };
    }

    const weightModal = document.getElementById('weight-modal');
    const weightModalTitle = document.getElementById('weight-modal-title');
    const weightModalItems = document.getElementById('weight-modal-items');
    const weightModalAdd = document.getElementById('weight-modal-add');
    const weightModalNewValue = document.getElementById('weight-modal-new-value');
    let currentWeightRow = null;

    function createWeightItem(choice, weight, removable = false) {
        const itemDiv = document.createElement('div');
        itemDiv.className = 'weight-item';

        const label = document.createElement('label');
        label.textContent = choice;

        const input = document.createElement('input');
        input.type = 'number';
        input.min = '0';
        input.required = true;
        input.value = weight;
        input.dataset.choice = choice;

        itemDiv.appendChild(label);
        itemDiv.appendChild(input);

        if (removable) {
            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.className = 'weight-item-remove';
            removeBtn.textContent = '×';
            removeBtn.onclick = () => itemDiv.remove();
            itemDiv.appendChild(removeBtn);
        }

        return itemDiv;
    }

    function openWeightModal(row) {
        currentWeightRow = row;
        const optionName = row.dataset.name;
        const type = row.dataset.type;
        const choices = JSON.parse(row.dataset.choices || '[]');
        const existingWeights = row.dataset.weights ? JSON.parse(row.dataset.weights) : null;
        const range = row.dataset.range ? row.dataset.range.split(',').map(Number) : null;

        weightModalTitle.textContent = `Configure weights for: ${optionName}`;
        weightModalItems.innerHTML = '';

        const allowCustom = range || choices.length === 0;
        if (allowCustom) {
            weightModalAdd.classList.remove('hidden');
            if (range) {
                weightModalNewValue.min = range[0];
                weightModalNewValue.max = range[1];
                weightModalNewValue.placeholder = `Value (${range[0]}-${range[1]})`;
            } else {
                weightModalNewValue.removeAttribute('min');
                weightModalNewValue.removeAttribute('max');
                weightModalNewValue.placeholder = 'Value';
            }
        } else {
            weightModalAdd.classList.add('hidden');
        }

        choices.forEach(choice => {
            weightModalItems.appendChild(createWeightItem(choice, existingWeights?.[choice] ?? 0, false));
        });

        if (existingWeights) {
            Object.entries(existingWeights).forEach(([choice, weight]) => {
                if (!choices.includes(choice)) {
                    weightModalItems.appendChild(createWeightItem(choice, weight, true));
                }
            });
        }

        weightModal.classList.remove('hidden');
    }

    document.getElementById('weight-modal-add-btn')?.addEventListener('click', () => {
        if (!weightModalNewValue.checkValidity()) {
            weightModalNewValue.reportValidity();
            return;
        }
        const value = weightModalNewValue.value.trim();
        if (!value) return;

        const existing = weightModalItems.querySelector(`input[data-choice="${CSS.escape(value)}"]`);
        if (existing) {
            existing.focus();
            return;
        }

        weightModalItems.appendChild(createWeightItem(value, 50, true));
        weightModalNewValue.value = '';
    });

    weightModalNewValue?.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            document.getElementById('weight-modal-add-btn').click();
        }
    });

    function closeWeightModal() {
        weightModal.classList.add('hidden');
        currentWeightRow = null;
    }

    function saveWeights(e) {
        e.preventDefault();
        if (!currentWeightRow) return;

        const weights = {};
        let hasAnyWeight = false;
        weightModalItems.querySelectorAll('input').forEach(input => {
            const weight = parseInt(input.value);
            if (weight > 0) {
                weights[input.dataset.choice] = weight;
                hasAnyWeight = true;
            }
        });

        const weightedBtn = currentWeightRow.querySelector('.option-weighted');
        if (hasAnyWeight) {
            currentWeightRow.dataset.weights = JSON.stringify(weights);
            weightedBtn.classList.add('active');
            // Disable other inputs when weighted
            currentWeightRow.querySelectorAll('input:not([type="hidden"]), select').forEach(el => el.disabled = true);
            const randomBtn = currentWeightRow.querySelector('.option-random');
            if (randomBtn) randomBtn.classList.remove('active');
        } else {
            delete currentWeightRow.dataset.weights;
            weightedBtn.classList.remove('active');
            currentWeightRow.querySelectorAll('input:not([type="hidden"]), select').forEach(el => el.disabled = false);
        }

        closeWeightModal();
    }

    document.getElementById('weight-modal-form')?.addEventListener('submit', saveWeights);
    document.getElementById('weight-modal-cancel')?.addEventListener('click', closeWeightModal);

    weightModal?.addEventListener('click', (e) => {
        if (e.target === weightModal) closeWeightModal();
    });

    document.querySelectorAll('.option-weighted').forEach(btn => {
        btn.onclick = () => {
            const row = btn.closest('.option-row');
            openWeightModal(row);
        };
    });

    document.querySelectorAll('.tooltip-icon').forEach(icon => {
        const text = icon.dataset.tooltip;
        if (!text) return;

        const tip = document.createElement('span');
        tip.className = 'tooltip-box';
        tip.textContent = text;
        icon.appendChild(tip);

        const position = () => {
            tip.style.left = '';

            const iconRect = icon.getBoundingClientRect();
            const tipRect = tip.getBoundingClientRect();

            let left = (icon.offsetWidth - tipRect.width) / 2;

            const absLeft = iconRect.left + left;
            const leftMargin = window.innerWidth <= 768 ? 60 : 230;
            const rightMargin = 20;
            if (absLeft < leftMargin) {
                left -= absLeft - leftMargin;
            }
            if (absLeft + tipRect.width > window.innerWidth - rightMargin) {
                left -= (absLeft + tipRect.width) - (window.innerWidth - rightMargin);
            }

            tip.style.left = left + 'px';
        };

        icon.addEventListener('mouseenter', position);
        icon.addEventListener('focus', position);
        icon.onclick = (e) => e.preventDefault();
    });
</script>
{% endblock %}
