{% extends "base.html" %}

{% block main %}
<noscript>
    Gotta enable javascript for this to work, sorry
</noscript>

<form>
    <select name="apworld" id="apworld">
        <option value="" {%+ if selected_apworld.is_none() %} selected {% endif %}>Select apworld</option>
        {% for (apworld_name, world_name) in self.apworlds %}
        <option value="{{apworld_name}}" {%+ if selected_apworld.as_ref() == Some(*apworld_name) %} selected {% endif %}>{{world_name}}</option>
        {% endfor %}
    </select>

    {% if let Some(selected_apworld) = self.selected_apworld %}
        <select name="version" id="version">
            <option value="" {%+ if selected_version.is_none() %} selected {% endif %}>Select version</option>
            {% for version in self.versions %}
            <option value="{{version}}" {%+ if selected_version.as_ref() == Some(*version) %} selected {% endif %}>{{version}}</option>
            {% endfor %}
        </select>
    {% endif %}
</form>

{% if self.selected_apworld.is_none() %}
<form method="POST" action="/options/edit" id="yaml-upload-form">
    <input type="file" name="yaml_file" id="yaml-upload" accept=".yaml,.yml" style="display:none">
    <input type="hidden" name="yaml" id="yaml-content">
    <button type="button" id="upload-yaml-btn">Upload existing YAML</button>
</form>
{% endif %}

{% if !self.warnings.is_empty() %}
<div id="yaml-warnings">
    <strong>The following options from your YAML are not recognized (they may have been removed or renamed):</strong>
    <ul>
        {% for warning in self.warnings %}
        <li><code>{{warning}}</code></li>
        {% endfor %}
    </ul>
</div>
{% endif %}

{% if let (Some(apworld), Some(version)) = (self.selected_apworld.as_ref(), self.selected_version.as_ref()) %}
<form id="options-form" method="POST" action="/options/{{apworld}}/{{version}}/download">
{% else %}
<form id="options-form">
{% endif %}
{% if self.options.is_some() %}
    <div class="option-row">
        <label for="player">Player name</label>
        <input type="text" id="player" name="player" placeholder="Player" value="{{self.prefilled_player_name.as_deref().unwrap_or_default()}}"/>
    </div>
{% endif %}
{% if let Some(option_groups) = self.options %}
    {% for (option_group, options) in option_groups.iter() %}
        <h2>{{option_group}}</h2>
        {% for (option_name, option_def) in options.iter() %}
            {% let prefilled = self.get_prefilled(option_name) %}
            {% call option_input(option_name, option_def, prefilled) %}{% endcall %}
        {% endfor %}
    {% endfor %}
    <button type="submit">Download YAML</button>
{% endif %}
</form>

<div id="weight-modal" class="modal hidden">
    <div class="modal-content">
        <h3 id="weight-modal-title">Configure Weights</h3>
        <div id="weight-modal-add" class="weight-add-row hidden">
            <input type="number" id="weight-modal-new-value" placeholder="Value">
            <button type="button" id="weight-modal-add-btn">Add</button>
        </div>
        <div id="weight-modal-items"></div>
        <div class="modal-buttons">
            <button type="button" id="weight-modal-save">Save</button>
            <button type="button" id="weight-modal-cancel">Cancel</button>
        </div>
    </div>
</div>
{% endblock %}

{% macro option_input(option_name, option_def, prefilled) %}
    <div class="option-row" data-type="{{option_def.ty}}" data-default="{{option_def.default_json()}}" data-name="{{option_name}}"
        {%~ match option_def.ty.as_str() ~%}
        {%~ when "bool" %} data-choices='["true","false"]'
        {%~ when "choice" %} data-choices='{{option_def.choices()|json}}'
        {%~ when "named_range" %} data-choices='{{option_def.suggestions()|json}}' data-range='{{option_def.range_bounds().0}},{{option_def.range_bounds().1}}'
        {%~ when "text_choice" %} data-choices='{{option_def.suggestions()|json}}'
        {%~ when "range" %} data-range='{{option_def.range_bounds().0}},{{option_def.range_bounds().1}}'
        {%~ else ~%}
        {%~ endmatch ~%}
        {%~ if self.is_weighted(prefilled) %} data-weights='{{self.weights_json(prefilled)}}'{% endif ~%}
    >
        {% match option_def.ty.as_str() %}
        {% when "bool" %}
            <input type="checkbox" id="{{option_name}}" class="bool-checkbox" {%+ if self.prefilled_bool(prefilled, option_def.default_str() == "true") %}checked{% endif %}/>
        {% else %}
        {% endmatch %}
        <label for="{{option_name}}">{{option_def.display_name}} <i class="fa fa-circle-question tooltip-icon" tabindex="0" data-tooltip="{{option_def.description}}"></i></label>
        {% match option_def.ty.as_str() %}
        {% when "bool" %}
        {% when "range" %}
            {% let (min, max) = option_def.range_bounds() %}
            <div class="range-wrapper">
                {% if let Some(v) = prefilled %}
                <input id="{{option_name}}" type="number" value="{{v}}" min="{{min}}" max="{{max}}" required/>
                {% else %}
                <input id="{{option_name}}" type="number" value="{{option_def.default}}" min="{{min}}" max="{{max}}" required/>
                {% endif %}
                <span class="range-hint">({{min}} - {{max}})</span>
            </div>
        {% when "named_range" %}
            {% let (min, max) = option_def.range_bounds() %}
            {% let pstr = self.prefilled_str(prefilled) %}
            <select id="{{option_name}}" class="preset-select" data-target="{{option_name}}_input">
                <option value="">Custom</option>
                {% for suggestion in option_def.suggestions() %}
                <option value="{{suggestion}}" {%+ if pstr == Some(*suggestion) %}selected{% endif %}>{{suggestion}}</option>
                {% endfor %}
            </select>
            <div class="range-wrapper">
                {% if let Some(v) = prefilled %}
                <input type="number" id="{{option_name}}_input" value="{{v}}" min="{{min}}" max="{{max}}" required {%+ if pstr.is_some() %}disabled{% endif %}/>
                {% else %}
                <input type="number" id="{{option_name}}_input" value="{{option_def.default}}" min="{{min}}" max="{{max}}" required/>
                {% endif %}
                <span class="range-hint">({{min}} - {{max}})</span>
            </div>
        {% when "text_choice" %}
            {% let pstr = self.prefilled_str(prefilled) %}
            <select id="{{option_name}}" class="preset-select" data-target="{{option_name}}_input">
                <option value="">Custom</option>
                {% for suggestion in option_def.suggestions() %}
                <option value="{{suggestion}}" {%+ if pstr == Some(*suggestion) %}selected{% endif %}>{{suggestion}}</option>
                {% endfor %}
            </select>
            {% if let Some(ps) = pstr %}
                {% let is_preset = self.suggestions_contain(&option_def.suggestions(), ps) %}
                <input type="text" id="{{option_name}}_input" value="{{ps}}" {%+ if is_preset %}disabled{% endif %}/>
            {% else %}
            <input type="text" id="{{option_name}}_input" value="{{option_def.default_str()}}"/>
            {% endif %}
        {% when "choice" %}
            {% let pstr = self.prefilled_str(prefilled) %}
            <select id="{{option_name}}">
            {% for choice in option_def.choices() %}
                <option value="{{choice}}" {%+ if pstr.unwrap_or(option_def.default_str()) == choice %}selected{% endif %}>{{choice}}</option>
            {% endfor %}
            </select>
        {% when "set" %}
            {% let parr = self.prefilled_array(prefilled) %}
            <select id="{{option_name}}" multiple>
            {% for value in option_def.valid_keys() %}
                {% if let Some(arr) = parr %}
                <option value="{{value}}" {%+ if self.array_contains_str(arr, value) %}selected{% endif %}>{{value}}</option>
                {% else %}
                <option value="{{value}}" {%+ if option_def.default_contains(value) %}selected{% endif %}>{{value}}</option>
                {% endif %}
            {% endfor %}
            </select>
        {% when "list" %}
            {% let parr = self.prefilled_array(prefilled) %}
            <div class="item-list" data-type="list" data-default="{{option_def.default_json()}}" {%+ if parr.is_some() %}data-prefilled="true"{% endif %}>
                <div class="item-list-items" id="{{option_name}}_items">
                    {% if let Some(arr) = parr %}
                        {% for item in arr %}
                            {% if let Some(name) = item.as_str() %}
                            <div class="item-list-item" data-name="{{name}}">
                                <span>{{name}}</span>
                                <button type="button" class="item-list-remove">×</button>
                            </div>
                            {% endif %}
                        {% endfor %}
                    {% endif %}
                </div>
                <div class="item-list-add-row">
                    <input type="text" list="{{option_name}}_datalist" placeholder="Add item..." class="item-list-input"/>
                    <datalist id="{{option_name}}_datalist">
                        {% for value in option_def.valid_keys() %}
                        <option value="{{value}}">
                        {% endfor %}
                    </datalist>
                    <button type="button" class="item-list-add">+</button>
                </div>
            </div>
        {% when "counter" %}
            {% let pobj = self.prefilled_object(prefilled) %}
            <div class="item-list" data-type="counter" data-default="{{option_def.default_json()}}" {%+ if pobj.is_some() %}data-prefilled="true"{% endif %}>
                <div class="item-list-items" id="{{option_name}}_items">
                    {% if let Some(obj) = pobj %}
                        {% for (name, qty) in obj %}
                            <div class="item-list-item" data-name="{{name}}">
                                <span>{{name}}</span>
                                <input type="number" min="1" value="{{qty}}" class="item-list-qty"/>
                                <button type="button" class="item-list-remove">×</button>
                            </div>
                        {% endfor %}
                    {% endif %}
                </div>
                <div class="item-list-add-row">
                    <input type="text" list="{{option_name}}_datalist" placeholder="Add item..." class="item-list-input"/>
                    <datalist id="{{option_name}}_datalist">
                        {% for value in option_def.valid_keys() %}
                        <option value="{{value}}">
                        {% endfor %}
                    </datalist>
                    <button type="button" class="item-list-add">+</button>
                </div>
            </div>
        {% when "dict" %}
            <span class="option-not-supported">Not editable in this UI</span>
        {% else %}
            {% if let Some(v) = self.prefilled_str(prefilled) %}
            <input id="{{option_name}}" type="text" value="{{v}}"/>
            {% else %}
            <input id="{{option_name}}" type="text" value="{{option_def.default_str()}}"/>
            {% endif %}
        {% endmatch %}
        {% if option_def.ty != "dict" %}
        <button type="button" class="option-reset" title="Reset to default"><i class="fa fa-rotate"></i></button>
        {% endif %}
        {% match option_def.ty.as_str() %}
        {% when "set" %}
        {% when "list" %}
        {% when "counter" %}
        {% when "dict" %}
        {% else %}
        <button type="button" class="option-random" title="Randomize"><i class="fa fa-dice"></i></button>
        {% endmatch %}
        {% match option_def.ty.as_str() %}
        {% when "choice" | "named_range" | "bool" | "text_choice" | "range" %}
        <button type="button" class="option-weighted {%+ if self.is_weighted(prefilled) %} active{% endif %}" title="Configure weights"><i class="fa fa-scale-balanced"></i></button>
        {% else %}
        {% endmatch %}
    </div>
{% endmacro %}

{% block scripts %}
<script>
    // YAML upload handling
    document.getElementById('upload-yaml-btn')?.addEventListener('click', () => {
        document.getElementById('yaml-upload').click();
    });

    document.getElementById('yaml-upload')?.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const content = await file.text();
        document.getElementById('yaml-content').value = content;
        document.getElementById('yaml-upload-form').submit();
    });

    const apworld_input = document.getElementById("apworld");
    apworld_input.onchange = function(event) {
        const apworld_name = event.target.value;
        if (!apworld_name) return;
        window.location.href = `/options/${apworld_name}`
    }

    const version_input = document.getElementById("version");
    if (version_input) {
        version_input.onchange = function(event) {
            const apworld_name = apworld_input.value;
            const version = event.target.value;
            if (!version) return;
            window.location.href = `/options/${apworld_name}/${version}`
        }
    }

    function getRowValue(row) {
        const type = row.dataset.type;
        const randomBtn = row.querySelector('.option-random');
        if (randomBtn && randomBtn.classList.contains('active')) {
            return 'random';
        }

        const weightedBtn = row.querySelector('.option-weighted');
        if (weightedBtn && weightedBtn.classList.contains('active') && row.dataset.weights) {
            return JSON.parse(row.dataset.weights);
        }

        switch (type) {
            case 'bool':
                return row.querySelector('.bool-checkbox').checked;
            case 'range':
                return parseInt(row.querySelector('input[type="number"]').value);
            case 'named_range': {
                const select = row.querySelector('.preset-select');
                if (select.value) return select.value;
                return parseInt(document.getElementById(select.dataset.target).value);
            }
            case 'text_choice': {
                const select = row.querySelector('.preset-select');
                if (select.value) return select.value;
                return document.getElementById(select.dataset.target).value;
            }
            case 'choice':
                return row.querySelector('select').value;
            case 'set':
                return Array.from(row.querySelector('select[multiple]').selectedOptions).map(o => o.value);
            case 'list':
                return Array.from(row.querySelectorAll('.item-list-item')).map(item => item.dataset.name);
            case 'counter': {
                const counter = {};
                row.querySelectorAll('.item-list-item').forEach(item => {
                    counter[item.dataset.name] = parseInt(item.querySelector('.item-list-qty').value);
                });
                return counter;
            }
            default:
                return row.querySelector('input[type="text"]')?.value || '';
        }
    }

    function createListItem(type, name, quantity = 1) {
        const item = document.createElement('div');
        item.className = 'item-list-item';
        item.dataset.name = name;

        const nameSpan = document.createElement('span');
        nameSpan.textContent = name;
        item.appendChild(nameSpan);

        if (type === 'counter') {
            const qtyInput = document.createElement('input');
            qtyInput.type = 'number';
            qtyInput.min = '1';
            qtyInput.value = quantity;
            qtyInput.className = 'item-list-qty';
            item.appendChild(qtyInput);
        }

        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.textContent = '×';
        removeBtn.className = 'item-list-remove';
        removeBtn.onclick = () => item.remove();
        item.appendChild(removeBtn);

        return item;
    }

    function resetToDefault(row) {
        const type = row.dataset.type;
        if (!type || type === 'dict') return;
        const defaultValue = JSON.parse(row.dataset.default);

        // If the default is "random", activate the random button
        if (defaultValue === 'random') {
            const randomBtn = row.querySelector('.option-random');
            if (randomBtn) {
                randomBtn.classList.add('active');
                row.querySelectorAll('input, select').forEach(input => input.disabled = true);
            }
            return;
        }

        switch (type) {
            case 'bool':
                row.querySelector('.bool-checkbox').checked = defaultValue === true || defaultValue === 'true';
                break;
            case 'range':
                row.querySelector('input[type="number"]').value = defaultValue;
                break;
            case 'named_range':
            case 'text_choice': {
                const select = row.querySelector('.preset-select');
                const input = document.getElementById(select.dataset.target);
                const matchingOption = Array.from(select.options).find(opt => opt.value === String(defaultValue));
                if (matchingOption) {
                    select.value = String(defaultValue);
                    input.disabled = true;
                } else {
                    select.value = '';
                    input.value = defaultValue;
                    input.disabled = false;
                }
                break;
            }
            case 'choice':
                row.querySelector('select').value = defaultValue;
                break;
            case 'set':
                Array.from(row.querySelector('select[multiple]').options).forEach(opt => {
                    opt.selected = defaultValue.includes(opt.value);
                });
                break;
            case 'list':
            case 'counter': {
                const itemsContainer = row.querySelector('.item-list-items');
                itemsContainer.innerHTML = '';
                if (type === 'list' && Array.isArray(defaultValue)) {
                    defaultValue.forEach(name => itemsContainer.appendChild(createListItem(type, name)));
                } else if (type === 'counter' && typeof defaultValue === 'object') {
                    Object.entries(defaultValue).forEach(([name, qty]) => {
                        itemsContainer.appendChild(createListItem(type, name, qty));
                    });
                }
                break;
            }
            default: {
                const input = row.querySelector('input[type="text"]');
                if (input) input.value = defaultValue;
            }
        }
    }

    // Make multi-selects toggle on click without needing Ctrl
    document.querySelectorAll('select[multiple]').forEach(select => {
        select.onmousedown = (e) => {
            if (e.target.tagName === 'OPTION' && !e.shiftKey) {
                e.preventDefault();
                e.target.selected = !e.target.selected;
            }
        };
    });

    document.querySelectorAll('.option-row').forEach(row => {
        // Skip resetToDefault if items were pre-rendered server-side
        const itemList = row.querySelector('.item-list[data-prefilled="true"]');
        if (!itemList) {
            resetToDefault(row);
        }
        // Wire up remove buttons on pre-rendered items
        row.querySelectorAll('.item-list-remove').forEach(btn => {
            btn.onclick = () => btn.closest('.item-list-item').remove();
        });

        if (row.dataset.weights) {
            row.querySelectorAll('input:not([type="hidden"]), select').forEach(el => el.disabled = true);
        }

        const resetBtn = row.querySelector('.option-reset');
        if (resetBtn) resetBtn.onclick = () => {
            row.querySelectorAll('input, select').forEach(input => input.disabled = false);
            const randomBtn = row.querySelector('.option-random');
            if (randomBtn) randomBtn.classList.remove('active');
            const weightedBtn = row.querySelector('.option-weighted');
            if (weightedBtn) {
                weightedBtn.classList.remove('active');
                delete row.dataset.weights;
            }
            resetToDefault(row);
        };

        const randomBtn = row.querySelector('.option-random');
        if (randomBtn) randomBtn.onclick = () => {
            const isActive = randomBtn.classList.toggle('active');
            const inputs = row.querySelectorAll('input, select');

            if (isActive) {
                inputs.forEach(input => input.disabled = true);
                const weightedBtn = row.querySelector('.option-weighted');
                if (weightedBtn) {
                    weightedBtn.classList.remove('active');
                    delete row.dataset.weights;
                }
            } else {
                inputs.forEach(input => input.disabled = false);
                const defaultValue = JSON.parse(row.dataset.default);
                if (defaultValue !== 'random') {
                    resetToDefault(row);
                } else {
                    // For number inputs, set to minimum value
                    const numberInput = row.querySelector('input[type="number"]');
                    if (numberInput && numberInput.min) {
                        numberInput.value = numberInput.min;
                    }
                }
            }
        };
    });

    // Handle preset select changes (enable/disable custom input)
    document.querySelectorAll('.preset-select').forEach(select => {
        const input = document.getElementById(select.dataset.target);
        if (!input) return;
        select.onchange = () => { input.disabled = !!select.value; };
    });

    // Handle item-list add functionality
    document.querySelectorAll('.item-list').forEach(container => {
        const row = container.closest('.option-row');
        const type = row.dataset.type;
        const itemsContainer = container.querySelector('.item-list-items');
        const input = container.querySelector('.item-list-input');
        const addBtn = container.querySelector('.item-list-add');

        addBtn.onclick = () => {
            const name = input.value.trim();
            if (!name) return;

            if (type === 'counter') {
                const existing = itemsContainer.querySelector(`[data-name="${CSS.escape(name)}"]`);
                if (existing) {
                    const qtyInput = existing.querySelector('.item-list-qty');
                    qtyInput.value = parseInt(qtyInput.value) + 1;
                    input.value = '';
                    return;
                }
            }

            itemsContainer.appendChild(createListItem(type, name));
            input.value = '';
        };

        input.onkeypress = (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                addBtn.click();
            }
        };
    });

    const form = document.getElementById('options-form');
    if (form) {
        form.onsubmit = (e) => {
            e.preventDefault();
            if (!form.reportValidity()) return;

            const formData = new FormData();
            formData.append('player', document.getElementById('player')?.value || '');

            document.querySelectorAll('.option-row[data-name]').forEach(row => {
                const name = row.dataset.name;
                const value = getRowValue(row);
                formData.append(name, typeof value === 'object' || typeof value === 'boolean' ? JSON.stringify(value) : value);
            });

            fetch(form.action, {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) throw new Error('Download failed');
                const disposition = response.headers.get('Content-Disposition');
                const match = disposition?.match(/filename="(.+)"/);
                const filename = match ? match[1] : 'options.yaml';
                return response.blob().then(blob => ({ blob, filename }));
            })
            .then(({ blob, filename }) => {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.click();
                URL.revokeObjectURL(url);
            })
            .catch(err => alert('Failed to download: ' + err.message));
        };
    }

    const weightModal = document.getElementById('weight-modal');
    const weightModalTitle = document.getElementById('weight-modal-title');
    const weightModalItems = document.getElementById('weight-modal-items');
    const weightModalAdd = document.getElementById('weight-modal-add');
    const weightModalNewValue = document.getElementById('weight-modal-new-value');
    let currentWeightRow = null;

    function createWeightItem(choice, weight, removable = false) {
        const itemDiv = document.createElement('div');
        itemDiv.className = 'weight-item';

        const label = document.createElement('label');
        label.textContent = choice;

        const input = document.createElement('input');
        input.type = 'number';
        input.min = '0';
        input.value = weight;
        input.dataset.choice = choice;

        itemDiv.appendChild(label);
        itemDiv.appendChild(input);

        if (removable) {
            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.className = 'weight-item-remove';
            removeBtn.textContent = '×';
            removeBtn.onclick = () => itemDiv.remove();
            itemDiv.appendChild(removeBtn);
        }

        return itemDiv;
    }

    function openWeightModal(row) {
        currentWeightRow = row;
        const optionName = row.dataset.name;
        const type = row.dataset.type;
        const choices = JSON.parse(row.dataset.choices || '[]');
        const existingWeights = row.dataset.weights ? JSON.parse(row.dataset.weights) : null;
        const range = row.dataset.range ? row.dataset.range.split(',').map(Number) : null;

        weightModalTitle.textContent = `Configure weights for: ${optionName}`;
        weightModalItems.innerHTML = '';

        if (type === 'range' || (choices.length === 0 && range)) {
            weightModalAdd.classList.remove('hidden');
            if (range) {
                weightModalNewValue.min = range[0];
                weightModalNewValue.max = range[1];
                weightModalNewValue.placeholder = `Value (${range[0]}-${range[1]})`;
            }
            if (existingWeights) {
                Object.entries(existingWeights).forEach(([choice, weight]) => {
                    weightModalItems.appendChild(createWeightItem(choice, weight, true));
                });
            }
        } else {
            weightModalAdd.classList.add('hidden');
            choices.forEach(choice => {
                weightModalItems.appendChild(createWeightItem(choice, existingWeights?.[choice] ?? 0, false));
            });
        }

        weightModal.classList.remove('hidden');
    }

    document.getElementById('weight-modal-add-btn')?.addEventListener('click', () => {
        if (!weightModalNewValue.checkValidity()) {
            weightModalNewValue.reportValidity();
            return;
        }
        const value = weightModalNewValue.value.trim();
        if (!value) return;

        const existing = weightModalItems.querySelector(`input[data-choice="${CSS.escape(value)}"]`);
        if (existing) {
            existing.focus();
            return;
        }

        weightModalItems.appendChild(createWeightItem(value, 50, true));
        weightModalNewValue.value = '';
    });

    weightModalNewValue?.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            document.getElementById('weight-modal-add-btn').click();
        }
    });

    function closeWeightModal() {
        weightModal.classList.add('hidden');
        currentWeightRow = null;
    }

    function saveWeights() {
        if (!currentWeightRow) return;

        const weights = {};
        let hasAnyWeight = false;
        weightModalItems.querySelectorAll('input').forEach(input => {
            const weight = parseInt(input.value) || 0;
            if (weight > 0) {
                weights[input.dataset.choice] = weight;
                hasAnyWeight = true;
            }
        });

        const weightedBtn = currentWeightRow.querySelector('.option-weighted');
        if (hasAnyWeight) {
            currentWeightRow.dataset.weights = JSON.stringify(weights);
            weightedBtn.classList.add('active');
            // Disable other inputs when weighted
            currentWeightRow.querySelectorAll('input:not([type="hidden"]), select').forEach(el => el.disabled = true);
            const randomBtn = currentWeightRow.querySelector('.option-random');
            if (randomBtn) randomBtn.classList.remove('active');
        } else {
            delete currentWeightRow.dataset.weights;
            weightedBtn.classList.remove('active');
            currentWeightRow.querySelectorAll('input:not([type="hidden"]), select').forEach(el => el.disabled = false);
        }

        closeWeightModal();
    }

    document.getElementById('weight-modal-save')?.addEventListener('click', saveWeights);
    document.getElementById('weight-modal-cancel')?.addEventListener('click', closeWeightModal);

    weightModal?.addEventListener('click', (e) => {
        if (e.target === weightModal) closeWeightModal();
    });

    document.querySelectorAll('.option-weighted').forEach(btn => {
        btn.onclick = () => {
            const row = btn.closest('.option-row');
            openWeightModal(row);
        };
    });

    // Prevent tooltip clicks from triggering label behavior
    document.querySelectorAll('.tooltip-icon').forEach(icon => {
        icon.onclick = (e) => e.preventDefault();
    });
</script>
{% endblock %}
