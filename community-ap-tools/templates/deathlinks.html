<html>
    <head>
        <link rel="stylesheet" href="/static/contrib/font-awesome/css/all.min.css">
        <style>
* {
   color: white;
   background: black;
   box-sizing: border-box;
}

table, tr, td, th {
    border: 1px solid white;
    border-collapse: collapse;
}
table {
    margin-bottom: 1em;
}
td, th {
    padding: 2px;
}

.error-box {
    background-color: #610505;
    padding: 0.5em;
    width: 100%;
    margin-bottom: 2em;
}

button {
    cursor: pointer;
}
        </style>
    </head>
    <body id="main">
        {% if !is_session_valid %}
        <div class="error-box">The currently provided session is invalid. Commands will fail silently. Nothing I can do about the silent part...</div>
        {% endif %}

        <h1>Deathlinks</h1>

        <table>
            <tr>
                <td>Lobby Room</td>
                <td><a href="{{ lobby_root_url}}room/{{lobby_room.id}}">{{ lobby_room.name }}</a></td>
            </tr>
            <tr>
                <td>Pages</td>
                <td><a href="/">Main</a></td>
            </tr>
        </table>

        <h2>Deathlink Status</h2>
        <table id="deathlink-status-table">
            <thead>
                <tr>
                    <th>Slot</th>
                    <th>Player</th>
                    <th>Game</th>
                    <th>Discord</th>
                    <th>Status</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                {% for slot in slots %}
                <tr data-slot-id="{{ slot.id }}">
                    <td>{{ slot.id }}</td>
                    <td>{{ slot.name }}</td>
                    <td>{{ slot.game }}</td>
                    <td>@{{ slot.discord_handle }}</td>
                    <td class="deathlink-status">{% if slot.is_excluded %}Disabled{% else %}Enabled{% endif %}</td>
                    <td>
                        <button class="toggle-deathlink" data-slot-id="{{ slot.id }}">Toggle</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <h2>Deathlink Statistics</h2>
        <div id="deathlink-stats">
            {% if deathlinks.is_empty() %}
            <p>No deathlinks recorded yet.</p>
            {% else %}
            <p>Total deathlinks: {{ deathlinks.len() }}</p>
            <p>Deaths by slot:</p>
            <ul>
                {% for slot_count in deaths_by_slot %}
                <li>Slot {{ slot_count.slot }} ({{ slot_count.name }}): {{ slot_count.count }} deaths</li>
                {% endfor %}
            </ul>
            {% endif %}
        </div>

        <table id="deathlink-history-table">
            <thead>
                <tr>
                    <th>Time</th>
                    <th>Slot</th>
                    <th>Source</th>
                    <th>Cause</th>
                </tr>
            </thead>
            <tbody id="deathlink-history-body">
                {% for dl in deathlinks %}
                <tr>
                    <td>{{ dl.created_at }}</td>
                    <td>{{ dl.slot }}</td>
                    <td>{{ dl.source }}</td>
                    <td>{{ dl.cause.as_deref().unwrap_or("N/A") }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </body>

    <script>
        document.querySelectorAll('.toggle-deathlink').forEach(button => {
            button.addEventListener('click', async () => {
                const slotId = parseInt(button.dataset.slotId);
                const row = button.closest('tr');
                const statusCell = row.querySelector('.deathlink-status');
                const isExcluded = statusCell.innerText === 'Disabled';
                const method = isExcluded ? 'DELETE' : 'POST';
                await fetch('/api/deathlink_exclusions/' + slotId, { method });
                statusCell.innerText = isExcluded ? 'Enabled' : 'Disabled';
            });
        });
    </script>
</html>
